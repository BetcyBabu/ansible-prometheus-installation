---
- name: "Creating user prometheus"
  user:
    name: prometheus
    create_home: no

- name: "Creating /etc/prometheus folder"
  file:
    path: /etc/prometheus
    state: directory
    owner: prometheus
    group: prometheus

- name: "Creating /var/lib/prometheus folder"
  file:
    path: /var/lib/prometheus
    state: directory
    owner: prometheus
    group: prometheus

- name: "Downloading Prometheus"
  get_url:
    url: https://github.com/prometheus/prometheus/releases/download/v2.32.1/prometheus-2.32.1.linux-amd64.tar.gz
    dest: /home/

- name: "Extracting prometheus-*.tar.gz"
  unarchive:
    remote_src: yes
    src: /home/prometheus-2.32.1.linux-amd64.tar.gz
    dest: /home/

- name: "Moving extracted files to a folder prometheus-files"
  copy:
    remote_src: yes
    src: /home/prometheus-2.32.1.linux-amd64/
    dest: /home/prometheus-files/

- name: "Copy prometheus folder from prometheus-files to /usr/local/bin/"
  copy:
    remote_src: yes
    src: /home/prometheus-files/prometheus
    dest: /usr/local/bin/
    owner: prometheus
    group: prometheus
    mode: 0755

- name: "Copy promtool folder from prometheus-files to /usr/local/bin/"
  copy:
    remote_src: yes
    src: /home/prometheus-files/promtool
    dest: /usr/local/bin/
    owner: prometheus
    group: prometheus
    mode: 0755

- name: "Move the consoles folder from prometheus-files to /etc/prometheus folder"
  copy:
    remote_src: yes
    src: /home/prometheus-files/consoles
    dest: /etc/prometheus
    owner: prometheus
    group: prometheus

- name: "Move the console_libraries folder from prometheus-files to /etc/prometheus folder"
  copy:
    remote_src: yes
    src: /home/prometheus-files/console_libraries
    dest: /etc/prometheus
    owner: prometheus
    group: prometheus

- name: "Configuring Prometheus to monitor itself"
  copy:
    src: prometheus.yml
    dest: /etc/prometheus/
    owner: prometheus
    group: prometheus

- name: "Creating Prometheus Service File"
  copy:
    src: prometheus.service
    dest: /etc/systemd/system/
- name: "Restarting/Enabling Prometheus"
  service:
    name: prometheus
    state: restarted
    enabled: true
