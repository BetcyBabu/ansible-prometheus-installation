---
- name: "Creating user prometheus"
  user:
    name: prometheus
    create_home: no

- name: "Downloading Prometheus"
  get_url:
    url: https://github.com/prometheus/prometheus/releases/download/v2.32.1/prometheus-2.32.1.linux-amd64.tar.gz
    dest: /home/
  register: download_status

- name: "Extracting prometheus-*.tar.gz"
  when: download_status == true
  unarchive:
    remote_src: yes
    src: /home/prometheus-2.32.1.linux-amd64.tar.gz
    dest: /home/


- name: "Moving extracted files to a folder prometheus-files"
  when: download_status == true
  copy:
    remote_src: yes
    src: /home/prometheus-2.32.1.linux-amd64/
    dest: /home/prometheus-files/
    owner: prometheus
    group: prometheus

- name: "Copy prometheus folder from prometheus-files to /usr/local/bin/"
  when: download_status == true
  copy:
    remote_src: yes
    src: /home/prometheus-files/prometheus
    dest: /usr/local/bin/
    owner: prometheus
    group: prometheus
    mode: 0755

- name: "Copy promtool folder from prometheus-files to /usr/local/bin/"
  when: download_status == true
  copy:
    remote_src: yes
    src: /home/prometheus-files/promtool
    dest: /usr/local/bin/
    owner: prometheus
    group: prometheus
    mode: 0755

- name: "Configuring Prometheus to monitor itself"
  copy:
    src: prometheus.yml
    dest: /home/prometheus-files/
    owner: prometheus
    group: prometheus

- name: "Creating Prometheus Service File"
  copy:
    src: prometheus.service
    dest: /etc/systemd/system/
  register: prometheus_status

- name: "Restarting/Enabling Prometheus"
  when: prometheus_status == true
  service:
    name: prometheus
    state: restarted
    enabled: true
